<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>书圈</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" type="text/css" href="css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<link rel="stylesheet" type="text/css" href="css/iconfont.css" />
		<style type="text/css">
			.mui-card {
				margin-left: 0px;
				margin-right: 0px;
			}
			.mui-content>.mui-card:first-child {
			    margin-top: 0;
			}
			.mui-card-header img {
				border-radius: 50%;
			}
			
			a:active {
				color: inherit;
			}
			.mui-media-object {
				max-width: 50px !important;
				width: 50px;
				height: 70px !important;
				margin-right: 10px ;
			}
			.ref-book-info {
				padding-top: 0;
			}
			.mui-card-link {
				min-width: 60px;
			}
			.mui-content {
				height: 100%;
				overflow: hidden;
			}
			.mui-scroll-wrapper {
				height: 100%;
			}
			.mui-media .mui-media-object {
				max-width: 50px !important;
				width: 50px !important;
				height: 50px !important;
				border-radius: 50% !important;
			}
			.mui-ellipsis-4 {
			    display: -webkit-box;
			    overflow: hidden;
			    white-space: normal!important;
			    text-overflow: ellipsis;
			    word-wrap: break-word;
			    -webkit-line-clamp: 4;
			    -webkit-box-orient: vertical;
			}
			.bottom {
				position: fixed;
				height: 50px;
				max-height: 80px;
				width: 100%;
				bottom: 0;
				left: 0;
				background-color: #fff;
				padding: 5px 15px;
				display: flex;
			}
			.bottom .bottom-input {
				background-color: #efeff4;
				/*min-height: 100%;*/
				flex: 1;
				height: 40px;
				max-height: 80px;
				border-radius: 15px;
				margin: 0;
				border: 1px solid #BEBEBE
			}
			#comment {
				margin-bottom: 40px;
			}
			.send-btn {
				color: #0091FF;		
				line-height: 40px;
				margin-left: 5px;
				padding-left: 10px;
				font-weight: bold;
			}
		</style>
	</head>

	<body>
		<div class="mui-content" id="body">
		
				
			<!--<div class="mui-card">
				<div class="mui-card-header mui-card-media">
					<img src="img/tx.png" />
					<div class="mui-media-body">
						周猛
						<p>2016-06-30 15:30</p>
					</div>

				</div>
				<div class="mui-card-content">
					<div class="mui-card-content-inner">
						内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容内容
					</div>
					<div class="mui-card-content-inner ref-book-info flex">
			            <img class="mui-media-object" src="https://img3.doubanio.com/lpic/s27264181.jpg">
			            <div class="flex_1">
			               <div class="book-title mui-ellipsis-2">解忧杂货店</div>
			                <p class="mui-ellipsis-2">[日] 东野圭吾<br />
			                介绍介绍介绍介绍介绍介绍介绍介绍介绍介绍介绍介绍介绍</p>
			            </div>
					</div>
				</div>
			</div>
			<ul class="mui-table-view" id="comment">
			    <li class="mui-table-view-cell mui-media">
			        <a href="javascript:;">
			            <img class="mui-media-object mui-pull-left" src="img/avatar/m_01.png">
			            <div class="mui-media-body">
			                幸福
			                <p class="mui-ellipsis-4">能和心爱的人一起睡觉，是件幸福的事情；可是，打呼噜怎么办？</p>
			            </div>
			            <p>2017-10-20</p>
			        </a>
			    </li>
			    <li class="mui-table-view-cell mui-media">
			        <a href="javascript:;">
			            <img class="mui-media-object mui-pull-left" src="img/avatar/m_01.png">
			            <div class="mui-media-body">
			                木屋
			                <p class="mui-ellipsis-4">想要这样一间小木屋，夏天挫冰吃瓜，冬天围炉取暖.</p>
			            </div>
			        </a>
			    </li>
			    <li class="mui-table-view-cell mui-media">
			        <a href="javascript:;">
			            <img class="mui-media-object mui-pull-left" src="img/avatar/m_01.png">
			            <div class="mui-media-body">
			                CBD
			                <p class="mui-ellipsis-4">烤炉模式的城，到黄昏，如同打翻的调色盘一般.</p>
			            </div>
			        </a>
			    </li>
			</ul>	-->
		<!--<form class="bottom"><textarea class="bottom-input" placeholder="此刻的想法..."></textarea><div class="send-btn">发送</div></form>-->
		</div>
		<script src="js/jquery-2.1.0.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/public.js"></script>
		
		<script>
			
			openAccountDetail();
			openBookDetail();
			
			
			mui('body').on('tap', '.zan', function(e) {
				if(this.style.color == "rgb(246, 113, 5)") {
					return false;
				}
				this.style.color = "rgb(246, 113, 5)";
				var _id = this.dataset.id;
				var count = $(this).find(".like-count").text();
				$(this).find(".like-count").text(parseInt(count) + 1);
				
				var _data = {
					userId : localStorage.getItem("userId"),
					dynamicId :_id
				}
				muiPost(api.dynamicLike, _data, function(data){})
				
			})
			
			
			mui.plusReady(function() {
				
				var _data = {
					userId : localStorage.getItem("userId")
				}
				
				var _self = plus.webview.currentWebview();
				var self = JSON.parse(_self.key);

				_data.dynamicId = self.id;
				
				var dynamicStr = '<div class="mui-card">' +
								'<div class="mui-card-header mui-card-media account-detail" data-key="'+self.user.id+'">' +
									'<img src="img/avatar/'+ self.user.headIcon +'.png" />' +
									'<div class="mui-media-body">' +
										self.user.nickName +
										'<p>' + self.createTime +'</p>' +
									'</div>' +
				
								'</div>' +
								'<div class="mui-card-content">' +
									'<div class="mui-card-content-inner">' +
										self.content +
									'</div>' +
									'<div class="mui-card-content-inner ref-book-info flex book-detail" data-key="' + self.book.isbn+'">' +
							            '<img class="mui-media-object" src="'+ self.book.images.large+'">' +
							            '<div class="flex_1">' +
							               '<div class="book-title mui-ellipsis-2">'+ self.book.title+'</div>' +
							                '<p class="mui-ellipsis-2">'+ self.book.author+'<br />' +
							                	self.book.summary+'</p>' +
							            '</div>' +
									'</div>' +
								'</div>' +
							'</div>';
				
				var publishStr = '<div class="bottom"><textarea id="comment-content" class="bottom-input" placeholder="此刻的想法..."></textarea><div class="send-btn" id="send-btn">发送</div></div>';
				
				var promise = new Promise(function(resolve, reject) {
					muiGet(api.commentInfos + "?dynamicId=" + self.id + "&pageIndex=1",function(data){
						resolve(data);
					})
				});
				
				promise.then(function(value) {
					var comments = value.data;
					var commentStr = "";
					if(comments){
					
						comments.forEach(function(item,index) {
							commentStr += '<li class="mui-table-view-cell mui-media">' +
									        '<a href="javascript:;">' +
									            '<img class="mui-media-object mui-pull-left account-detail" data-key="'+item.userId+'" src="img/avatar/'+item.headIcon+'.png">' +
									            '<div class="mui-media-body">' + item.nickName +
									                '<p class="mui-ellipsis-4">'+item.content+'</p>' +
									            '</div>' +
									            '<p>'+item.createTime+'</p>' +
									        '</a>' +
									    '</li>';
							
						})
						commentStr = '<ul class="mui-table-view" id="comment">'+commentStr+'</ul>'
					}
					document.getElementById("body").innerHTML = dynamicStr + commentStr + publishStr;
					
				

					//提交评论模块
					document.getElementById('send-btn').addEventListener('tap',function () {
						
						var cContent = document.getElementById("comment-content");
						console.log(cContent.value.trim());
						
						if(cContent.value.trim() == "") {
							return false;
						}
						
						_data.content = cContent.value.trim();
						
						
						var promise = new Promise(function(resolve, reject) {
							muiPost(api.commentPublish, _data, function(data){
								resolve(data);
							})
							
						});
						
						promise.then(function(data) {
							if(data.errorCode != 0) {
								mui.alert(data.errorMsg, "出错了...");
							}
							cContent.blur();
							
							plus.webview.currentWebview().reload();
							
						});
						
						
						
					});
					
				});
				
			})
			
			
			
			
			
			
			
		</script>
	</body>

</html>